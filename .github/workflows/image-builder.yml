#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/image-builder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
# Copyright (c) 2025 icyray
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: Image Builder

on:
  workflow_call:
    inputs:
      repo_url:
        required: true
        type: string
      repo_branch:
        required: true
        type: string
      feeds_conf:
        required: false
        type: string
        default: feeds.conf.default
      config_file:
        required: true
        type: string
        default: .config
      diy_p1_sh:
        required: false
        type: string
        default: diy-part1.sh
      diy_p2_sh:
        required: false
        type: string
        default: diy-part2.sh
      release_file:
        required: false
        type: string
        default: release.md
      upload_bin_dir:
        required: false
        type: boolean
        default: false
      upload_firmware:
        required: false
        type: boolean
        default: true
      upload_release:
        required: false
        type: boolean
        default: true
      tz:
        required: false
        type: string
        default: Asia/Shanghai
    outputs:
      repo_hash:
        value: ${{ jobs.build.outputs.repo_hash }}

env:
  REPO_URL: ${{ inputs.repo_url }}
  REPO_BRANCH: ${{ inputs.repo_branch }}
  FEEDS_CONF: ${{ inputs.feeds_conf }}
  CONFIG_FILE: ${{ inputs.config_file }}
  DIY_P1_SH: ${{ inputs.diy_p1_sh }}
  DIY_P2_SH: ${{ inputs.diy_p2_sh }}
  RELEASE_FILE: ${{ inputs.release_file }}
  UPLOAD_BIN_DIR: ${{ inputs.upload_bin_dir }}
  UPLOAD_FIRMWARE: ${{ inputs.upload_firmware }}
  UPLOAD_RELEASE: ${{ inputs.upload_release }}
  TZ: ${{ inputs.tz }}

jobs:
  build:
    runs-on: ubuntu-22.04
    # 关键：添加权限声明，确保上传Release有足够权限
    permissions:
      contents: write
      actions: read
    outputs:
      repo_hash: ${{ steps.get-hash.outputs.repo_hash }}
    
    steps: 
      - name: 检查服务器配置
        run: |
          echo "已知CPU型号（降序）：7763,8370C,8272CL,8171M,E5系列"
          echo "--------------------------CPU信息--------------------------"
          echo "CPU物理数量:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
          echo -e "CPU核心及版本信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------硬盘信息--------------------------"
          echo -e "$(df -hT)"

      - name: 清理系统
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
          
      - name: 验证空间清理结果
        run: |
          echo "Free up disk space complete"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
       
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive       
        run: |
          set -euo pipefail
          # 临时取消严格模式，允许非核心包安装失败
          set +e
          
          # ===================== 步骤1：启用i386架构（核心） =====================
          echo "=== 启用i386架构支持 ==="
          sudo dpkg --add-architecture i386
          # 验证架构
          dpkg --print-foreign-architectures | grep -q i386 && echo "✅ i386架构启用成功" || echo "⚠️ i386架构启用失败，继续执行"
          
          # ===================== 步骤2：更换为Ubuntu官方源（海外环境稳定） =====================
          echo "=== 更换为Ubuntu官方源 ==="
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
          sudo tee /etc/apt/sources.list > /dev/null << EOF
          deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
          deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
          EOF
          
          # ===================== 步骤3：正确刷新APT缓存（无错误参数） =====================
          echo "=== 刷新APT缓存 ==="
          sudo -E apt-get clean
          # 仅用基础参数更新，dpkg已启用i386，APT会自动加载双架构索引
          sudo -E apt-get update -v -y --fix-missing || true
          
          # ===================== 步骤4：分批次安装依赖（核心包优先+容错） =====================
          echo "=== 批次1：安装OpenWrt编译核心依赖（必选） ==="
          # 只保留编译必需的包，去掉非必需的（antlr3/ecj/fastjar等）
          sudo -E apt-get -qq install -y --fix-missing \
            build-essential binutils bison flex gawk gcc g++ git make patch pkgconf \
            gcc-multilib g++-multilib libc6-dev-i386 lib32gcc-s1 \
            libssl-dev libz-dev libncurses-dev libreadline-dev libglib2.0-dev \
            curl wget unzip rsync subversion squashfs-tools upx-ucl zstd
          
          echo "=== 批次2：安装可选工具（失败不影响） ==="
          # 非核心工具，安装失败则警告，不终止流程
          sudo -E apt-get -qq install -y --fix-missing \
            ack-grep ccache clang cmake device-tree-compiler gettext-base autopoint \
            libelf-dev libgmp3-dev libmpc-dev libmpfr-dev lld llvm lrzsz mkisofs \
            nano ninja-build python3 python3-pip python3-ply qemu-utils re2c scons \
            swig texinfo uglifyjs.terser xmlto xxd || echo "⚠️ 部分可选工具安装失败，不影响编译"
          
          # ===================== 步骤5：创建兼容软链接 =====================
          echo "=== 创建兼容软链接 ==="
          sudo ln -sf /usr/bin/ack-grep /usr/bin/ack || true
          sudo ln -sf /usr/bin/uglifyjs.terser /usr/bin/uglifyjs || true
          
          # ===================== 步骤6：安装Node.js+pnpm =====================
          echo "=== 安装Node.js+pnpm ==="
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo -E apt-get -qq install -y nodejs --fix-missing || true
          npm config set registry https://registry.npmmirror.com
          sudo npm install -g pnpm --unsafe-perm || true
          
          # ===================== 步骤7：清理+环境配置 =====================
          echo "=== 清理缓存+配置环境 ==="
          sudo -E apt-get -qq autoremove --purge || true
          sudo -E apt-get -qq clean || true
          sudo timedatectl set-timezone "$TZ" || true
          sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir || true
          # 新增swap分区（解决本地构建LLVM内存不足问题）
          echo "=== 配置8GB swap分区 ==="
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          # 验证swap是否生效
          swapon --show
           free -h
          
          # 恢复严格模式
          set -e
          
          # ===================== 验证核心依赖 =====================
          echo "=== 验证核心依赖 ==="
          gcc --version | head -n1
          echo "✅ 核心编译环境初始化完成（部分可选工具缺失不影响）"
          
      - name: Clone source code
        working-directory: /workdir
        run: |
          set -euo pipefail
          df -hT $PWD
          # 容错：已存在则拉取最新代码
          if [ -d openwrt ]; then
            cd openwrt && git pull origin $REPO_BRANCH
          else
            git clone $REPO_URL -b $REPO_BRANCH openwrt
          fi
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
      - name: Append custom device definition
        run: |
          set -euo pipefail
          # 容错：检查文件是否存在
          DEVICE_DEF="$GITHUB_WORKSPACE/openwrt-mod/cudy-tr3000-512.mk"
          if [ -f "$DEVICE_DEF" ]; then
            cd openwrt/target/linux/mediatek/image
            cat "$DEVICE_DEF" >> filogic.mk
            echo "✅ Custom device definition appended to filogic.mk"
          else
            echo "⚠️ 自定义设备定义文件不存在：$DEVICE_DEF，跳过追加"
          fi

      - name: Copy custom DTS file
        run: |
          set -euo pipefail
          # 容错：检查文件是否存在
          DTS_FILES="$GITHUB_WORKSPACE/openwrt-mod/mt7981*.dts"
          if ls $DTS_FILES 1> /dev/null 2>&1; then
            cd openwrt
            mkdir -p target/linux/mediatek/dts
            cp -v $DTS_FILES target/linux/mediatek/dts/
            echo "✅ 自定义DTS文件复制完成"
          else
            echo "⚠️ 未找到自定义DTS文件（$DTS_FILES），跳过复制"
          fi
   
      - name: Get repo hash
        id: get-hash
        run: echo "repo_hash=$(git -C openwrt rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Load custom feeds
        run: |
          set -euo pipefail
          # 容错：检查feeds配置文件是否存在
          if [ -e "$FEEDS_CONF" ]; then
            mv $FEEDS_CONF openwrt/feeds.conf.default
            echo "✅ 自定义Feeds配置已加载"
          else
            echo "⚠️ Feeds配置文件不存在：$FEEDS_CONF，使用默认配置"
          fi
          # 容错：检查DIY_P1脚本是否存在
          if [ -f "$DIY_P1_SH" ]; then
            chmod +x $DIY_P1_SH
            cd openwrt
            $GITHUB_WORKSPACE/$DIY_P1_SH
            echo "✅ DIY_P1脚本执行完成"
          else
            echo "⚠️ DIY_P1脚本不存在：$DIY_P1_SH，跳过执行"
          fi

      - name: Update feeds
        run: |
          set -euo pipefail
          cd openwrt && ./scripts/feeds update -a

      - name: Install feeds
        run: |
          set -euo pipefail
          # 修复语法错误：续行符+在OpenWrt目录执行
          cd openwrt && \
            ./scripts/feeds install -a && \
            # 容错：仅当qmodem feeds存在时强制安装
            (./scripts/feeds install -a -f -p qmodem || echo "⚠️ QModem Feeds安装失败，可能源不存在")

      - name: Load custom configuration
        run: |
          set -euo pipefail
          # 容错：检查自定义文件/配置
          if [ -d "files" ]; then
            mv files openwrt/files
            echo "✅ 自定义files目录已加载"
          else
            echo "⚠️ 未找到files目录，跳过"
          fi
          if [ -e "$CONFIG_FILE" ]; then
            mv $CONFIG_FILE openwrt/.config
            echo "✅ 自定义配置文件已加载"
          else
            echo "⚠️ 配置文件不存在：$CONFIG_FILE，使用默认配置"
          fi
          # 容错：检查DIY_P2脚本
          if [ -f "$DIY_P2_SH" ]; then
            chmod +x $DIY_P2_SH
            cd openwrt
            $GITHUB_WORKSPACE/$DIY_P2_SH
            echo "✅ DIY_P2脚本执行完成"
          else
            echo "⚠️ DIY_P2脚本不存在：$DIY_P2_SH，跳过执行"
          fi

      - name: Download package
        id: package
        run: |
          set -euo pipefail
          cd openwrt
          make defconfig
          make download -j$(nproc)
          # 清理空文件
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "✅ 依赖包下载完成"

      - name: Compile the firmware
        id: compile
        run: |
          set -euo pipefail
          cd openwrt
          CORE_NUM=$(nproc)
          echo -e "$CORE_NUM thread compile"
          # 编译失败时输出详细日志并保存
          make -j$CORE_NUM || {
            echo "⚠️ 多线程编译失败，切换为单线程详细日志模式"
            make -j1 V=s 2>&1 | tee compile_error.log
            exit 1
          }
          # 提取设备名称（容错）
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          if [ -s DEVICE_NAME ]; then
            DEVICE_NAME_VAL=$(cat DEVICE_NAME)
          else
            DEVICE_NAME_VAL="unknown"
          fi
          echo "DEVICE_NAME=$DEVICE_NAME_VAL" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +"%Y%m%d%H%M%S")" >> $GITHUB_ENV  # 加秒级避免标签重复
          echo "✅ 固件编译完成"

      - name: Upload compile log (if failed)
        uses: actions/upload-artifact@v4
        if: steps.compile.conclusion == 'failure'
        with:
          name: compile_error_log_${{ env.FILE_DATE }}
          path: openwrt/compile_error.log
          retention-days: 30

      - name: Check space usage
        if: (!cancelled())
        run: df -hT

      - name: Upload bin directory
        uses: actions/upload-artifact@v4
        if: steps.compile.conclusion == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        with:
          name: OpenWrt_bin_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
          path: openwrt/bin
          retention-days: 7

      - name: Organize files
        id: organize
        if: steps.compile.conclusion == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          set -euo pipefail
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "✅ 固件文件整理完成"

      - name: Upload firmware directory
        uses: actions/upload-artifact@v4
        if: steps.organize.conclusion == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
          retention-days: 30

      - name: Generate release tag
        id: tag
        if: steps.compile.conclusion == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          set -euo pipefail
          RELEASE_TAG=$(date +"%Y.%m.%d-%H%M%S")  # 秒级标签避免重复
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          # 容错：创建release文件（不存在则新建）
          touch "${RELEASE_FILE}"
          BADGE=$(mktemp)
          # 生成状态徽章
          cat > "$BADGE" << EOF
          [![Build Time](https://img.shields.io/badge/build-$(date +"%Y--%m--%d_%H:%M")-brightgreen?logo=github)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) \
          ![Device](https://img.shields.io/badge/device-$(echo ${{ env.DEVICE_NAME }} | sed 's/-/--/g')-blue) \
          [![Source Repo](https://img.shields.io/badge/source-repo-orange?logo=github)](${REPO_URL}/tree/${REPO_BRANCH}) \
          [![Commit](https://img.shields.io/badge/commit-$(git -C openwrt rev-parse --short HEAD)-yellow?logo=github)](${REPO_URL}/commit/$(git -C openwrt rev-parse HEAD))
          EOF
          # 容错：插入徽章（无旧徽章则插在第一行）
          grep -q "!\[Badge\]" "${RELEASE_FILE}" && \
            sed -i "/!\[Badge\]/r ${BADGE}" "${RELEASE_FILE}" && \
            sed -i "/!\[Badge\]/d" "${RELEASE_FILE}" || \
            sed -i "1r ${BADGE}" "${RELEASE_FILE}"
          echo "✅ Release标签和徽章生成完成"

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: steps.tag.conclusion == 'success' && steps.organize.conclusion == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: ${{ env.RELEASE_FILE }}
          files: ${{ env.FIRMWARE }}/*
          draft: false
          prerelease: false

  cleanup:
    if: success() || failure()
    uses: ./.github/workflows/clean-up.yml
    needs: build
    with:
      clean-release: true
